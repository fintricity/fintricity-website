# Kendra Labs Website: Architectural & Deployment Documentation

This document provides a detailed technical overview of how the Kendra Labs website is structured, built, and deployed to Hostinger.

## üèó Architecture

### Next.js 15 Standalone Mode
The application uses the Next.js **Standalone Output** feature. This optimizes the build by including only the necessary files (and a minimal subset of `node_modules`) required to run the server in a production environment.

*   **Build Output:** `./frontend/.next/standalone/`
*   **Static Assets:** Public files and static chunks are manually copied into the standalone folder during the build process to ensure self-containment.
*   **Entry Point:** `server.js` (generated by Next.js).

### Data-Driven UI
The frontend is decoupled from its content. Most sections (Hero, Features, Industry Lists) are populated via local JSON files in `frontend/content/`. This allows for structural changes to be made in code while content updates remain safe and isolated.

---

## üöÄ Deployment Pipeline (GitHub Actions)

The deployment is automated via `.github/workflows/deploy.yml`.

### 1. Build Phase
*   **Environment:** Node.js 20 on Ubuntu Latest.
*   **Secrets:** Build-time secrets (Sentry DSN, PostHog Key, HubSpot ID) are injected as `NEXT_PUBLIC_*` variables.
*   **Optimization:** `npm install --legacy-peer-deps` is used to handle dependency resolution in Next.js 15 environments.

### 2. Synchronization Phase
*   **Tool:** `rsync` over SSH (Port 65002).
*   **Path:** Standalone build artifacts are synced to `${{ secrets.HOSTINGER_DEPLOY_PATH }}`.
*   **Cleanup:** The `--delete` flag ensures that stale files on the server are removed to match the current build.

### 3. Restart Phase (SSH Remote Execution)
The script executes a series of commands on the Hostinger server:
1.  **Environment Setup:** Sets the PATH to include Node.js 20 and configures `UV_THREADPOOL_SIZE=1` to fit within Hostinger's shared environment constraints.
2.  **Process Management:** 
    *   Finds existing processes running `server.js` or `next-server`.
    *   Precisely kills them using `kill -9`.
    *   Starts the new process using `nohup` to ensure it persists after the SSH session closes.
3.  **Binding:** The server binds to `HOSTNAME=0.0.0.0` and `PORT=3000`.

---

## üåê Infrastructure & Proxying

Hostinger serves traffic via Apache, but the application runs as a Node.js process. The bridge between the two is handled by `.htaccess`.

### The Proxy Bridge
Located at `~/public_html/.htaccess`, the following rules force Apache to act as a reverse proxy:

```apache
RewriteEngine On
RewriteRule ^$ http://localhost:3000/ [P,L]
RewriteRule ^(.*)$ http://localhost:3000/$1 [P,L]
```

*   **[P]:** Forces the proxy flag (mod_proxy).
*   **[L]:** Last rule; stops further processing.

### Conflict Resolution (WordPress)
Hostinger accounts often come with WordPress pre-installed. The deployment script proactively prevents conflicts by:
*   Renaming `public_html/index.php` to `index.php.bak`.
*   Renaming `public_html/default.php` to `default.php.bak`.
This ensures Apache uses the `.htaccess` rules instead of executing PHP.

---

## üõ† Troubleshooting

### 503 Service Unavailable
This error typically means the Apache proxy cannot find the Node.js process.
*   **Check Binding:** Ensure the process is bound to `0.0.0.0` (not just `127.0.0.1`).
*   **Check Port:** Verify the process is listening on port `3000`. The deployment log includes an internal `curl -I http://localhost:3000` check to verify this.
*   **Check Logs:** View `output.log` and `error.log` in the deployment directory.

### Process Not Persisting
Hostinger's automated monitors may occasionally kill long-running processes if they exceed memory limits.
*   **Memory:** If the site goes down frequently, check the Sentry logs for memory leaks.
*   **Auto-Restart:** The GitHub Action acts as the primary restart mechanism.

### Logs
*   **GitHub Action Logs:** Best for debugging build failures.
*   **Server Logs (`output.log` / `error.log`):** Best for debugging runtime crashes.
*   **Sentry:** Best for debugging client-side and server-side logic errors.

---

¬© 2026 Kendra Labs Engineering.
